import streamlit as st
from nebula3.gclient.net import ConnectionPool
from nebula3.Config import Config
from pyvis.network import Network
import json
import tempfile

st.set_page_config(page_title="NebulaGraph Query Studio", layout="wide")

# ----------------- session_state 初始化 -----------------
for key, default in [
    ("client", None),
    ("spaces", []),
    ("history", []),
    ("query", 'MATCH p=(v)-[e]->(v2) RETURN p LIMIT 20'),
]:
    if key not in st.session_state:
        st.session_state[key] = default


# ----------------- Nebula 连接 -----------------
@st.cache_resource
def init_client(ip: str, port: int, user: str, password: str):
    config = Config()
    config.max_connection_pool_size = 20
    pool = ConnectionPool()
    ok = pool.init([(ip, port)], config)
    if not ok:
        raise RuntimeError("无法连接 NebulaGraph，请检查 IP/端口")

    client = pool.get_session(user, password)
    return client


def list_spaces(client):
    """
    使用 execute_json，而不是直接去解析 Value 对象
    返回 space 名称列表
    """
    raw = client.execute_json("SHOW SPACES")
    data = json.loads(raw)

    results = data.get("results", [])
    if not results:
        return []

    first = results[0]
    rows = first.get("data", [])
    spaces = []
    for item in rows:
        row = item.get("row", [])
        if row:
            # SHOW SPACES 只有一列，就是 space 名
            spaces.append(row[0])
    return spaces


# ----------------- 图数据解析：使用 dict_for_vis -----------------
def result_to_vis_data(result):
    """
    使用官方提供的 dict_for_vis 接口生成可视化用的数据，
    这样我们就不需要直接访问 Value / Vertex / Edge 内部结构了
    """
    try:
        vis = result.dict_for_vis()
    except AttributeError:
        # 说明 nebula3-python 太老了，建议升级
        raise RuntimeError(
            "当前 nebula3-python 不支持 ResultSet.dict_for_vis()，"
            "请先执行：pip install -U nebula3-python"
        )

    # 规范结构参考官方文档：
    # {
    #   "nodes": [{ "id": "...", "labels": [...], "props": {...} }],
    #   "edges": [{ "src": "...", "dst": "...", "name": "...", "props": {...} }],
    #   ...
    # }
    nodes = vis.get("nodes", [])
    edges = vis.get("edges", [])
    return nodes, edges


def visualize_graph(nodes, edges):
    net = Network(height="650px", width="100%", bgcolor="#1e1e1e", font_color="white")
    net.force_atlas_2based()

    # nodes: {id, labels, props}
    for n in nodes:
        node_id = str(n.get("id"))
        labels = n.get("labels") or []
        label = ",".join(labels) if labels else node_id
        props = n.get("props") or {}

        net.add_node(
            node_id,
            label=label,
            title=json.dumps(props, ensure_ascii=False, indent=2),
            size=25,
        )

    # edges: {src, dst, name, props}
    for e in edges:
        src = str(e.get("src"))
        dst = str(e.get("dst"))
        name = e.get("name") or ""
        props = e.get("props") or {}

        net.add_edge(
            src,
            dst,
            label=name,
            title=json.dumps(props, ensure_ascii=False, indent=2),
        )

    tmp = tempfile.NamedTemporaryFile(delete=False, suffix=".html")
    net.save_graph(tmp.name)
    return tmp.name


# ----------------- Sidebar：连接 / Space 选择 -----------------
st.sidebar.header("NebulaGraph 配置")

ip = st.sidebar.text_input("IP", "127.0.0.1")
port = st.sidebar.number_input("Port", 9669, step=1)
user = st.sidebar.text_input("User", "root")
password = st.sidebar.text_input("Password", "nebula", type="password")

if st.sidebar.button("连接 / 重连", use_container_width=True):
    try:
        client = init_client(ip, int(port), user, password)
        st.session_state["client"] = client
        st.session_state["spaces"] = list_spaces(client)
        if st.session_state["spaces"]:
            st.sidebar.success("连接成功！")
        else:
            st.sidebar.warning("连接成功，但没有 Space，请先在 Nebula 中创建 Space。")
    except Exception as e:
        st.session_state["client"] = None
        st.session_state["spaces"] = []
        st.sidebar.error(f"连接失败：{e}")

client = st.session_state["client"]
spaces = st.session_state["spaces"]

if client is None:
    st.warning("请先在左侧连接 NebulaGraph。")
    st.stop()

if not spaces:
    st.warning("当前没有可用 Space。")
    st.stop()

space = st.sidebar.selectbox("选择 Space", spaces)
use_res = client.execute(f"USE {space}")
if not use_res.is_succeeded():
    st.error(f"切换 Space 失败：{use_res.error_msg()}")
    st.stop()

# ----------------- 主界面：查询 & 结果 -----------------
st.title("NebulaGraph 图查询平台（稳定版，无 Value API 依赖）")

query = st.text_area(
    "输入 nGQL（建议返回图结构，如 MATCH / GET SUBGRAPH）：",
    key="query",
    height=150,
)

col_run, col_clear = st.columns(2)
run = col_run.button("执行查询", use_container_width=True)
clear_hist = col_clear.button("清空历史", use_container_width=True)

if clear_hist:
    st.session_state["history"] = []

if run:
    if not query.strip():
        st.warning("请输入查询语句")
    else:
        try:
            result = client.execute(query)
            if not result.is_succeeded():
                st.error(f"查询失败：{result.error_msg()}")
            else:
                # 记录历史
                if query not in st.session_state["history"]:
                    st.session_state["history"].insert(0, query)

                nodes, edges = result_to_vis_data(result)

                st.subheader("查询结果概览")
                st.write(f"节点数：{len(nodes)}  |  边数：{len(edges)}")

                with st.expander("查看原始 nodes 数据"):
                    st.json(nodes)
                with st.expander("查看原始 edges 数据"):
                    st.json(edges)

                html_path = visualize_graph(nodes, edges)
                with open(html_path, "r", encoding="utf-8") as f:
                    st.components.v1.html(f.read(), height=680)
        except Exception as e:
            st.error(f"执行异常：{e}")


# ----------------- 侧栏：查询历史 -----------------
st.sidebar.subheader("查询历史（点击填充）")
for i, q in enumerate(st.session_state["history"][:20]):
    if st.sidebar.button(q, key=f"hist_{i}"):
        st.session_state["query"] = q
