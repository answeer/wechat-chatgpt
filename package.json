def extract_graph_data_from_df(df):
    """从 DataFrame 抽取节点/边（适配 Nebula 常见返回列）"""
    nodes = {}
    edges = []

    if df is None or df.empty:
        return nodes, edges

    cols_lower = [c.lower() for c in df.columns]

    src_candidates = ["_src", "src", "source", "from", "src_id"]
    dst_candidates = ["_dst", "dst", "target", "to", "dst_id"]

    src_col = next((c for c in df.columns if c.lower() in src_candidates), None)
    dst_col = next((c for c in df.columns if c.lower() in dst_candidates), None)

    # --- 边模式 ---
    if src_col and dst_col:
        label_col = next((c for c in df.columns if c.lower() in ["edge_type", "type", "name", "label"]), None)

        for _, row in df.iterrows():
            src = str(row[src_col])
            dst = str(row[dst_col])

            nodes.setdefault(src, {"label": src, "props": {}})
            nodes.setdefault(dst, {"label": dst, "props": {}})

            label = str(row[label_col]) if label_col else ""
            props = {k: str(v) for k, v in row.items() if k not in [src_col, dst_col]}

            edges.append({
                "src": src,
                "dst": dst,
                "label": label,
                "props": props
            })

        return nodes, edges

    # --- 顶点模式 ---
    vid_candidates = ["vid", "_vid", "id", "vertex_id"]
    vid_col = next((c for c in df.columns if c.lower() in vid_candidates), None)

    if vid_col:
        for _, row in df.iterrows():
            vid = str(row[vid_col])
            props = {k: str(v) for k, v in row.items() if k != vid_col}
            nodes.setdefault(vid, {"label": vid, "props": props})
    else:
        # --- 兜底：每行一个点 ---
        for idx, row in df.iterrows():
            vid = str(idx)
            props = {k: str(v) for k, v in row.items()}
            nodes.setdefault(vid, {"label": vid, "props": props})

    return nodes, edges





def extract_graph_data_from_result(result):
    """从 ResultSet 抽取节点/边（能识别 Vertex/Edge 就用）"""
    nodes = {}
    edges = []

    if result is None or (hasattr(result, "is_succeeded") and not result.is_succeeded()):
        return nodes, edges

    try:
        for row in result:
            for val in row.values():
                v = val

                # Vertex
                try:
                    if hasattr(v, "is_vertex") and v.is_vertex():
                        vx = v.as_vertex() if hasattr(v, "as_vertex") else None
                        if vx:
                            vid = None
                            if hasattr(vx, "vid"):
                                vid = vx.vid()
                            elif hasattr(vx, "get_id"):
                                vid = vx.get_id()

                            if vid is not None:
                                vid = str(vid)
                                nodes.setdefault(vid, {"label": vid, "props": {}})
                except Exception:
                    pass

                # Edge
                try:
                    if hasattr(v, "is_edge") and v.is_edge():
                        ex = v.as_edge() if hasattr(v, "as_edge") else None
                        if ex:
                            src = None
                            dst = None

                            for attr in ["src_id", "src_vertex_id", "src"]:
                                if hasattr(ex, attr):
                                    obj = getattr(ex, attr)
                                    src = obj() if callable(obj) else obj
                                    break
                            for attr in ["dst_id", "dst_vertex_id", "dst"]:
                                if hasattr(ex, attr):
                                    obj = getattr(ex, attr)
                                    dst = obj() if callable(obj) else obj
                                    break

                            if src is not None and dst is not None:
                                src = str(src); dst = str(dst)
                                nodes.setdefault(src, {"label": src, "props": {}})
                                nodes.setdefault(dst, {"label": dst, "props": {}})
                                edges.append({"src": src, "dst": dst, "label": "", "props": {}})
                except Exception:
                    pass

        return nodes, edges

    except Exception:
        return {}, []



def visualize_graph_pyvis(nodes, edges, height="650px"):
    """用 PyVis 生成 Nebula Studio 风格的交互图"""
    try:
        from pyvis.network import Network

        net = Network(
            height=height,
            width="100%",
            bgcolor="#ffffff",
            font_color="#222",
            directed=True
        )

        # 类 Studio 的力导向参数
        net.barnes_hut(
            gravity=-20000,
            central_gravity=0.3,
            spring_length=120,
            spring_strength=0.02,
            damping=0.09
        )

        # 节点
        for nid, meta in nodes.items():
            label = meta.get("label", nid)
            props = meta.get("props", {})
            title = "<br>".join([f"{k}: {v}" for k, v in props.items()]) if props else label

            net.add_node(
                nid,
                label=label,
                title=title,
                shape="dot",
                size=18
            )

        # 边
        for e in edges:
            title = "<br>".join([f"{k}: {v}" for k, v in e.get("props", {}).items()]) if e.get("props") else ""
            net.add_edge(
                e["src"],
                e["dst"],
                label=e.get("label", ""),
                title=title,
                arrows="to"
            )

        html = net.generate_html()
        components.html(html, height=700, scrolling=True)
        return True

    except Exception as e:
        st.warning(f"PyVis render failed: {str(e)}")
        return False



result = st.session_state.session.execute(query)
st.session_state.last_result_raw = result


with col2:
    if st.button("Clear Results", use_container_width=True):
        if 'last_result_df' in st.session_state:
            del st.session_state.last_result_df
        if 'last_result_raw' in st.session_state:
            del st.session_state.last_result_raw



elif viz_type == "Graph View":
    raw_result = st.session_state.get("last_result_raw", None)

    # 1) 优先从 ResultSet 抽取
    nodes, edges = extract_graph_data_from_result(raw_result) if raw_result else ({}, [])

    # 2) 不够就从 DataFrame 抽取兜底
    if len(nodes) == 0 and len(edges) == 0:
        nodes, edges = extract_graph_data_from_df(df)

    # 3) 仍然没有图数据
    if len(nodes) == 0 and len(edges) == 0:
        st.info("No graph structure detected. Showing table view instead:")
        st.dataframe(df, use_container_width=True)
    else:
        # 4) PyVis（最像 Nebula Studio）
        ok = visualize_graph_pyvis(nodes, edges)

        # 5) PyVis 失败再用你原 Plotly 版本兜底
        if not ok:
            fig = visualize_graph_from_dataframe(df)
            if fig:
                st.plotly_chart(fig, use_container_width=True)
            else:
                st.dataframe(df, use_container_width=True)


import streamlit.components.v1 as components
